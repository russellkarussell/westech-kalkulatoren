<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Wärmepumpen‑Speicher‑Kalkulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Berechne die optimale Größe deines Wärmepumpen-Pufferspeichers – inkl. EVU-Sperrzeiten, Heizflächen, Warmwasser und Komfortzuschlag." />
  <style>
    /* --- THEME VARIABLES --- */
    :root {
      /* Dark Theme (Default) */
      --c-brand: #1d6fe9;
      --c-brand-hover: #2b7aff;
      --brand: var(--c-brand);
      --c-text: #e5e7eb;
      --c-text-muted: #94a3b8;
      --c-text-header: #bfdbfe;
      --c-bg: #0b1220;
      --c-bg-panel: linear-gradient(180deg,#0e1a33 0%, #0b1220 100%);
      --c-bg-input: #0a162e;
      --c-bg-stat: #0c1830;
      --c-border: #1f2a44;
      --c-border-input: #233053;
      --c-border-stat: #21335b;
      --c-border-active: #2b67d3;
      --c-shadow: 0 8px 24px rgba(2,8,23,.45);
      --c-ring: rgba(24,102,196,.45);
      --c-thumb: conic-gradient(from 0deg,#3b82f6,#2563eb,#1e40af);
      --c-gauge-bg: #132447;
      --c-gauge-border: #28416f;
      --c-gauge-tick: #374b77;
    }

    html.light-mode {
      /* Light Theme */
      --c-brand: #1e70bf;
      --c-brand-hover: #165c9e;
      --brand: var(--c-brand);
      --c-text: #0f172a;
      --c-text-muted: #5b677a;
      --c-text-header: #1e70bf;
      --c-bg: #f6f9fc;
      --c-bg-panel: #ffffff;
      --c-bg-input: #ffffff;
      --c-bg-stat: #f9fbfe;
      --c-border: #e7edf5;
      --c-border-input: #d1d5db;
      --c-border-stat: #e9f1fb;
      --c-border-active: #1e70bf;
      --c-shadow: 0 6px 18px rgba(20,41,66,.08);
      --c-ring: rgba(30,112,191,.18);
      --c-thumb: var(--c-brand);
      --c-gauge-bg: #eaf2fb;
      --c-gauge-border: #d7e6f9;
      --c-gauge-tick: #c4d8f2;
    }

    /* --- BASE & LAYOUT --- */
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: var(--c-bg); color: var(--c-text); line-height:1.55;
      transition: background-color .2s ease, color .2s ease;
    }
    header{max-width:1080px;margin:28px auto 8px;padding:0 18px}
    h1{font-size:1.9rem;margin:4px 0 8px}
    p.kicker{color: var(--c-text-header);letter-spacing:.06em;text-transform:uppercase;font-weight:700;margin:0 0 10px;font-size:.9rem}
    main{max-width:1080px;margin:0 auto;padding:8px 18px 60px;display:grid;grid-template-columns:1.1fr .9fr;gap:22px}

    /* --- RESPONSIVE FIXES --- */
    @media (max-width:980px){ 
        main{grid-template-columns:1fr} 
        .row{grid-template-columns:1fr}
    }

    /* --- COMPONENTS --- */
    .panel{
      background: var(--c-bg-panel);
      border:1px solid var(--c-border); border-radius:14px; padding:16px;
      box-shadow: var(--c-shadow);
    }
    .panel h2{font-size:1.15rem;margin:0 0 12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{margin:10px 0}
    .label{display:flex;align-items:center;gap:8px;font-size:.95rem;margin-bottom:6px; justify-content: space-between;}
    .help{color: var(--c-text-muted);font-size:.88rem;margin-top:4px}
    select, input[type="number"], input[type="text"]{
      width:100%; background: var(--c-bg-input); color: var(--c-text); border:1px solid var(--c-border-input);
      border-radius:10px; padding:10px 12px; outline:none;
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    select:focus, input:focus{border-color: var(--c-border-active); box-shadow:0 0 0 4px var(--c-ring)}

    /* System & Emitter Cards */
    .card-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:8px 0 6px}
    .card-btn{
      position:relative; cursor:pointer; user-select:none;
      background: var(--c-bg-input); border:1px solid var(--c-border-input); border-radius:14px; padding:14px;
      display:flex; gap:12px; align-items:center; min-height:92px;
      transition:transform .08s ease, border-color .12s ease, box-shadow .12s ease;
      text-align: left;
    }
    .card-btn:hover{border-color: var(--c-border-active);}
    .card-btn.active{border-color: var(--c-border-active); box-shadow:0 0 0 4px var(--c-ring); transform:translateY(-1px)}
    .card-title{font-weight:700;margin:0 0 4px; color: var(--c-text);}
    .card-sub{color: var(--c-text-muted);font-size:.9rem;margin:0}

    /* Themed defaults used by inline SVGs */
    .card-svg { 
      --body: var(--c-bg-input); 
      --line: var(--c-border-input); 
      --soft: var(--c-bg-panel); 
      --ink: var(--c-text); 
    }

    /* ICON SIZING – unified */
    .card-svg { width: 64px; height: 64px; flex: 0 0 64px; display: grid; place-items: center; }
    .card-svg svg { width: 100%; height: 100%; max-width: 100%; max-height: 100%; }

    .emitter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
    .emitter-card { flex-direction: column; text-align: center; padding: 14px 10px; min-height: 120px; justify-content: center; }
    .emitter-card .card-svg { width: 72px; height: 72px; flex: 0 0 72px; margin-bottom: 8px; }

    .small-card { flex-direction: column; text-align: center; padding: 12px 10px; min-height: 110px; justify-content: center; }
    .small-card .card-svg { width: 72px; height: 72px; flex: 0 0 72px; margin-bottom: 6px; }

    /* Slider + Number */
    .slider-wrap{display:grid;grid-template-columns:1fr 110px;gap:12px;align-items:center}
    input[type="range"]{
        -webkit-appearance:none; width:100%; height:8px; border-radius:999px; background: var(--c-border-input); outline:none; margin-top: 8px;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; width:22px; height:22px; border-radius:50%; background: var(--c-thumb); border:3px solid var(--c-bg-panel); box-shadow:0 2px 6px rgba(0,0,0,.35); cursor:pointer;
    }
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--c-border-input);background: var(--c-bg-input);color: var(--c-text-muted);border-radius:999px;padding:6px 10px;font-size:.88rem}

    /* Themed Sliders */
    .comfort-slider::-webkit-slider-thumb { background: #22c55e; }
    .space-slider::-webkit-slider-thumb { background: #a1a1aa; }
    .temp-slider { background: linear-gradient(90deg, #3b82f6, #fde047, #ef4444); }
    .temp-slider::-webkit-slider-thumb { background: var(--c-bg-panel); border-color: var(--c-text-muted); }

    /* Output Section */
    .result{ background: var(--c-bg-panel); border:1px solid var(--c-border); border-radius:14px; padding:16px; }
    .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:680px){ .stat-grid{grid-template-columns:1fr} }
    .stat{ background: var(--c-bg-stat);border:1px solid var(--c-border-stat);border-radius:12px;padding:12px }
    .stat h3{margin:0 0 6px;font-size:1rem;color: var(--c-text-header)}
    .stat .big{font-size:1.6rem;font-weight:800}

    /* Gauge Bar */
    .gauge{position:relative;height:14px;background: var(--c-gauge-bg);border:1px solid var(--c-gauge-border);border-radius:999px;margin-top:8px;overflow:hidden}
    .gauge .fill{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444);width:0%}
    .gauge .tick{position:absolute;top:-6px;width:2px;height:26px;background: var(--c-gauge-tick);opacity:.9}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;color: var(--c-text-muted);font-size:.85rem}
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:#22c55e}.dot.mid{background:#f59e0b}.dot.bad{background:#ef4444}
    .divider{height:1px;background: var(--c-border);margin:14px 0}
    .note{color: var(--c-text-muted);font-size:.92rem}
    .btn-primary{ background: var(--c-brand); color:#fff;padding:10px 14px;border-radius:10px;font-weight:700; text-decoration:none; display:inline-flex; align-items:center; gap:8px; border:none; cursor:pointer; }
    .btn-primary:hover{background: var(--c-brand-hover)}
    .footnote{color: var(--c-text-muted);font-size:.85rem}

    /* Theme Toggle Button */
    #themeToggle { background: none; border: 1px solid var(--c-border-input); color: var(--c-text-muted); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color .2s, border-color .2s; }
    #themeToggle:hover { background-color: var(--c-bg-input); border-color: var(--c-border-active); }
    #themeToggle .sun { display: none; }
    html.light-mode #themeToggle .moon { display: none; }
    html.light-mode #themeToggle .sun { display: block; }

    /* Tooltip */
    .tooltip { position: relative; display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border-radius: 50%; background-color: var(--c-border-input); color: var(--c-text-muted); font-size: 12px; font-weight: bold; cursor: help; }
    .tooltip-text { visibility: hidden; width: 280px; background-color: var(--c-bg-panel); color: var(--c-text); text-align: left; border-radius: 8px; padding: 10px; position: absolute; z-index: 10; bottom: 140%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.2s; box-shadow: var(--c-shadow); border: 1px solid var(--c-border); font-size: 0.85rem; font-weight: normal; line-height: 1.5; }
    .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: var(--c-border) transparent transparent transparent; }
    .tooltip:hover .tooltip-text, .tooltip:focus .tooltip-text { visibility: visible; opacity: 1; }

    /* Label Grouping */
    .label-group { display: flex; align-items: center; gap: 8px; }
    .label > .label-group { margin-right: auto; }

    /* Power Input Group */
    .power-input-group { background-color: var(--c-bg-input); border: 1px solid var(--c-border-input); border-radius: 12px; padding: 10px 14px; }
    .power-input-group .label { margin-bottom: 8px; }
    .power-value-wrapper { display: flex; align-items: center; gap: 8px; background-color: var(--c-bg-panel); border: 1px solid var(--c-border); border-radius: 8px; padding: 2px; }
    .power-input-group #powerNum { border: none; background: transparent; padding: 4px 8px; font-size: 1.1rem; font-weight: 700; text-align: right; width: 80px; color: var(--c-text); }
    .power-input-group #powerNum:focus { box-shadow: none; }
    .power-input-group .chip { border: none; background-color: var(--c-bg-input); }
    .power-input-group .range { width: 100%; margin-top: 4px; }

    @media (max-width:680px){ .panel{padding:20px} }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">
      
        <button id="themeToggle" title="Helles/Dunkles Design umschalten" aria-label="Helles/Dunkles Design umschalten">
            <svg class="moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            <svg class="sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        </button>
    </div>
    <p class="footnote">Finde mit wenigen Angaben die passende Pufferspeicher‑Größe. Alle Werte sind Richtwerte und ersetzen keine individuelle Fachplanung.</p>
  </header>

  <main>
    <!-- INPUTS -->
    <section class="panel" aria-labelledby="inputs">
      <h2 id="inputs">Eingaben</h2>

      <!-- Systemart -->
      <div class="field">
        <div class="label">
          <div class="label-group">
            <span>Systemart</span>
            <div class="tooltip" tabindex="0">?
              <span class="tooltip-text">
                <b>Monovalent:</b> Nur die Wärmepumpe heizt. Standard-Auslegung.<br>
                <b>Bivalent:</b> Ein zweiter Wärmeerzeuger (z.B. Gas/Öl) hilft an sehr kalten Tagen. Der Puffer muss größer sein, um die Umschaltpunkte zu überbrücken.<br>
                <b>Effekt:</b> Bivalente Systeme benötigen einen größeren Basisfaktor (ca. 45 l/kW statt 25 l/kW).
              </span>
            </div>
          </div>
        </div>
        <div class="card-grid" id="systemCards" role="listbox" aria-label="Systemart auswählen">
          <button class="card-btn active" type="button" role="option" aria-selected="true" aria-pressed="true" data-value="monovalent">
            <div class="card-svg" aria-hidden="true">
              <!-- MONOVALENT ICON -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" role="img">
                <style>
                  .unit { fill: var(--body); stroke: var(--line); stroke-width: 2; }
                  .unit-border { stroke: var(--ink); stroke-opacity:.08; }
                  .foot { fill: var(--ink); opacity:.18; }
                  .fan-ring { fill: none; stroke: var(--brand); stroke-width: 2; }
                  .fan-blade { fill: var(--brand); opacity:.95; }
                  .accent { fill: var(--brand); }
                </style>
                <g class="isolate">
                  <rect x="6" y="12" width="52" height="36" rx="8" class="unit"/>
                  <rect x="6" y="12" width="52" height="36" rx="8" class="unit unit-border" fill="none"/>
                  <rect x="14" y="48" width="8" height="3" rx="1" class="foot"/>
                  <rect x="42" y="48" width="8" height="3" rx="1" class="foot"/>
                  <g>
                    <circle cx="26" cy="30" r="10" class="fan-ring"/>
                    <circle cx="26" cy="30" r="2.4" class="accent"/>
                    <path class="fan-blade" d="M26 19.5c3.4 0 4.2 1.9 3 3.5s-4.1 1.6-5.6.5c-1.5-1.2-.9-4 2.6-4z"/>
                    <path class="fan-blade" d="M36.5 30c0 3.4-1.9 4.2-3.5 3s-1.6-4.1-.5-5.6c1.2-1.5 4-.9 4 2.6z"/>
                    <path class="fan-blade" d="M26 40.5c-3.4 0-4.2-1.9-3-3.5s4.1-1.6 5.6-.5c1.5 1.2.9 4-2.6 4z"/>
                    <path class="fan-blade" d="M15.5 30c0-3.4 1.9-4.2 3.5-3s1.6 4.1.5 5.6c-1.2 1.5-4 .9-4-2.6z"/>
                  </g>
                  <rect x="44" y="22" width="8" height="16" rx="2" fill="var(--body)" stroke="var(--line)" stroke-width="2"/>
                  <rect x="46.5" y="24.5" width="3" height="2.8" rx="1" fill="var(--brand)"/>
                  <rect x="46.5" y="29" width="5" height="2.2" rx="1" fill="var(--line)"/>
                  <rect x="46.5" y="33" width="5" height="2.2" rx="1" fill="var(--line)"/>
                </g>
              </svg>
            </div>
            <div>
              <p class="card-title">Monovalent</p>
              <p class="card-sub">Nur Wärmepumpe</p>
            </div>
          </button>
          <button class="card-btn" type="button" role="option" aria-selected="false" aria-pressed="false" data-value="bivalent">
            <div class="card-svg" aria-hidden="true">
              <!-- BIVALENT ICON -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 64" role="img">
                <style>
                  .unit { fill: var(--body); stroke: var(--line); stroke-width: 2; }
                  .unit-border { stroke: var(--ink); stroke-opacity:.08; }
                  .foot { fill: var(--ink); opacity:.18; }
                  .fan-ring { fill: none; stroke: var(--brand); stroke-width: 2; }
                  .fan-blade { fill: var(--brand); opacity:.95; }
                  .accent { fill: var(--brand); }
                  .boiler-ring { fill: none; stroke: var(--heat, #f97316); stroke-width: 2; }
                  .flame { fill: var(--heat, #f97316); }
                </style>
                <g transform="translate(0,0)">
                  <rect x="6" y="12" width="52" height="36" rx="8" class="unit"/>
                  <rect x="6" y="12" width="52" height="36" rx="8" class="unit unit-border" fill="none"/>
                  <rect x="14" y="48" width="8" height="3" rx="1" class="foot"/>
                  <rect x="42" y="48" width="8" height="3" rx="1" class="foot"/>
                  <g>
                    <circle cx="26" cy="30" r="10" class="fan-ring"/>
                    <circle cx="26" cy="30" r="2.4" class="accent"/>
                    <path class="fan-blade" d="M26 19.5c3.4 0 4.2 1.9 3 3.5s-4.1 1.6-5.6.5c-1.5-1.2-.9-4 2.6-4z"/>
                    <path class="fan-blade" d="M36.5 30c0 3.4-1.9 4.2-3.5 3s-1.6-4.1-.5-5.6c1.2-1.5 4-.9 4 2.6z"/>
                    <path class="fan-blade" d="M26 40.5c-3.4 0-4.2-1.9-3-3.5s4.1-1.6 5.6-.5c1.5 1.2.9 4-2.6 4z"/>
                    <path class="fan-blade" d="M15.5 30c0-3.4 1.9-4.2 3.5-3s1.6 4.1.5 5.6c-1.2 1.5-4 .9-4-2.6z"/>
                  </g>
                </g>
                <g transform="translate(60,28)">
                  <rect x="-4" y="-1" width="8" height="2" rx="1" fill="var(--line)"/>
                  <rect x="-1" y="-4" width="2" height="8" rx="1" fill="var(--line)"/>
                </g>
                <g transform="translate(72,0)">
                  <rect x="0" y="16" width="20" height="28" rx="3" class="unit"/>
                  <rect x="0" y="16" width="20" height="28" rx="3" class="unit unit-border" fill="none"/>
                  <circle cx="10" cy="30" r="7" class="boiler-ring"/>
                  <path class="flame" d="M10 24c2 3 2 5 0 7-2-1-3-3-2-5s1-3 2-2z"/>
                </g>
              </svg>
            </div>
            <div>
              <p class="card-title">Bivalent</p>
              <p class="card-sub">WP + Zweitgerät</p>
            </div>
          </button>
        </div>
      </div>

      <!-- Leistung -->
      <div class="field">
        <div class="power-input-group">
            <div class="label">
              <div class="label-group">
                <span>Wärmepumpenleistung</span>
                <div class="tooltip" tabindex="0">?
                  <span class="tooltip-text">Die thermische Leistung der Wärmepumpe ist der wichtigste Ausgangswert für die Berechnung. Typische Werte für ein Einfamilienhaus liegen zwischen 6 und 16 kW.</span>
                </div>
              </div>
              <div class="power-value-wrapper">
                <input id="powerNum" type="number" inputmode="decimal" min="1" max="100" step="0.1" value="10" />
                <span class="chip">kW</span>
              </div>
            </div>
            <input id="powerRange" class="range" type="range" min="3" max="30" step="0.5" value="10" />
        </div>
      </div>

      <!-- Heizflächen -->
      <div class="field">
        <div class="label">
          <div class="label-group">
            <span>Art der Heizflächen</span>
            <div class="tooltip" tabindex="0">?
              <span class="tooltip-text"><b>Flächenheizung:</b> Benötigt niedrige Vorlauftemperaturen und hat eine hohe Eigenspeicherkapazität. Der Puffer kann kleiner sein. <b>(~ −10 %)</b><br><br><b>Heizkörper:</b> Benötigen höhere Temperaturen, was kürzere Taktzeiten der WP verursachen kann. Ein größerer Puffer hilft, dies auszugleichen. <b>(~ +10 %)</b></span>
            </div>
          </div>
        </div>
        <div class="emitter-grid" id="emitterCards" role="listbox">
          <button class="card-btn emitter-card active" type="button" role="option" aria-selected="true" aria-pressed="true" data-value="flaeche">
            <div class="card-svg">
                <!-- FLÄCHENHEIZUNG ICON -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 64" role="img">
                  <style>
                    .card { fill:var(--body); stroke: var(--line); stroke-width:1.5; }
                    .house { fill: var(--soft); stroke: var(--line); stroke-width:1.5; }
                    .roof { fill: none; stroke: var(--line); stroke-width:1.8; stroke-linecap:round; }
                    .floor { fill:var(--body); stroke: var(--line); stroke-width:1.5; }
                    .pipe { fill: none; stroke: var(--brand); stroke-width:2.2; stroke-linecap:round; }
                    .tick { stroke: var(--line); stroke-width:1; }
                  </style>
                  <rect class="card" x="2" y="6" width="92" height="52" rx="10"/>
                  <g transform="translate(12,8)">
                    <rect class="house" x="10" y="12" width="40" height="22" rx="3"/>
                    <path class="roof" d="M6 16 L30 2 L54 16"/>
                    <rect x="20" y="18" width="8" height="8" rx="1.5" fill="var(--body)" stroke="var(--line)" stroke-width="1.5"/>
                    <line x1="24" y1="18" x2="24" y2="26" class="tick"/>
                    <line x1="20" y1="22" x2="28" y2="22" class="tick"/>
                  </g>
                  <g transform="translate(8,34)">
                    <rect class="floor" x="0" y="0" width="80" height="20" rx="4"/>
                    <path class="pipe" d="M6 6 H70 a4 4 0 0 1 4 4 v0 a4 4 0 0 1 -4 4 H14 a4 4 0 0 0 -4 4 v0 a4 4 0 0 0 4 4 H70" transform="translate(0,-2)"/>
                  </g>
                </svg>
            </div>
            <p class="card-title">Flächenheizung</p>
          </button>
          <button class="card-btn emitter-card" type="button" role="option" aria-selected="false" aria-pressed="false" data-value="radiator">
            <div class="card-svg">
              <!-- HEIZKÖRPER ICON -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 64" role="img">
                <style>
                  .card { fill:var(--body); stroke: var(--line); stroke-width:1.5; }
                  .panel { fill:var(--body); stroke: var(--line); stroke-width:1.6; }
                  .fin { stroke: var(--line); stroke-width:1.6; }
                  .cap { fill:var(--body); stroke: var(--line); stroke-width:1.6; }
                  .valve { fill: var(--brand); }
                  .pipe { stroke: var(--brand); stroke-width:2; fill:none; }
                  .tick { stroke: var(--line); stroke-width:1; stroke-linecap:round; }
                </style>
                <rect class="card" x="2" y="6" width="92" height="52" rx="10"/>
                <g transform="translate(12,16)">
                  <rect class="panel" x="0" y="0" width="56" height="28" rx="4"/>
                  <line class="fin" x1="8"  y1="4" x2="8"  y2="24"/>
                  <line class="fin" x1="16" y1="4" x2="16" y2="24"/>
                  <line class="fin" x1="24" y1="4" x2="24" y2="24"/>
                  <line class="fin" x1="32" y1="4" x2="32" y2="24"/>
                  <line class="fin" x1="40" y1="4" x2="40" y2="24"/>
                  <line class="fin" x1="48" y1="4" x2="48" y2="24"/>
                  <rect class="cap" x="56" y="6" width="12" height="16" rx="3"/>
                  <line class="tick" x1="59" y1="9"  x2="65" y2="9"/>
                  <line class="tick" x1="59" y1="12" x2="65" y2="12"/>
                  <line class="tick" x1="59" y1="15" x2="65" y2="15"/>
                  <path class="pipe" d="M56 22 H72"/>
                  <circle class="valve" cx="72" cy="22" r="3.5"/>
                  <path class="pipe" d="M72 22 v10 h-64"/>
                </g>
              </svg>
            </div>
            <p class="card-title">Heizkörper</p>
          </button>
          <button class="card-btn emitter-card" type="button" role="option" aria-selected="false" aria-pressed="false" data-value="misch">
            <div class="card-svg">
              <!-- MISCHSYSTEM ICON -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 64" role="img">
                <style>
                  .card { fill:var(--body); stroke: var(--line); stroke-width:1.5; }
                  .panel { fill:var(--body); stroke: var(--line); stroke-width:1.6; }
                  .fin { stroke: var(--line); stroke-width:1.6; }
                  .cap { fill:var(--body); stroke: var(--line); stroke-width:1.6; }
                  .valve { fill: var(--brand); }
                  .pipe { stroke: var(--brand); stroke-width:2; fill:none; }
                  .house { fill: var(--soft); stroke: var(--line); stroke-width:1.5; }
                  .roof { fill: none; stroke: var(--line); stroke-width:1.8; stroke-linecap:round; }
                  .floor { fill:var(--body); stroke: var(--line); stroke-width:1.5; }
                  .ufh { fill: none; stroke: var(--brand); stroke-width:2.2; stroke-linecap:round; }
                </style>
                <rect class="card" x="2" y="6" width="92" height="52" rx="10"/>
                <g transform="translate(8,14)">
                  <rect class="panel" x="0" y="0" width="40" height="24" rx="4"/>
                  <line class="fin" x1="6"  y1="4" x2="6"  y2="20"/>
                  <line class="fin" x1="12" y1="4" x2="12" y2="20"/>
                  <line class="fin" x1="18" y1="4" x2="18" y2="20"/>
                  <line class="fin" x1="24" y1="4" x2="24" y2="20"/>
                  <line class="fin" x1="30" y1="4" x2="30" y2="20"/>
                  <rect class="cap" x="40" y="4" width="10" height="16" rx="3"/>
                  <path class="pipe" d="M40 18 H52"/>
                  <circle class="valve" cx="52" cy="18" r="3"/>
                </g>
                <g transform="translate(50,10)">
                  <rect class="house" x="8" y="8" width="30" height="18" rx="3"/>
                  <path class="roof" d="M6 12 L23 2 L40 12"/>
                  <g transform="translate(2,26)">
                    <rect class="floor" x="0" y="0" width="44" height="16" rx="4"/>
                    <path class="ufh" d="M4 6 H40 a4 4 0 0 1 4 4 v0 a4 4 0 0 1 -4 4 H10 a4 4 0 0 0 -4 4 v0 a4 4 0 0 0 4 4 H40" transform="translate(0,-4)"/>
                  </g>
                </g>
              </svg>
            </div>
            <p class="card-title">Mischsystem</p>
          </button>
        </div>
      </div>

      <!-- Warmwasser & EVU -->
      <div class="row">
        <div class="field">
          <div class="label">
            <div class="label-group">
              <span>Warmwasserbereitung</span>
              <div class="tooltip" tabindex="0">?
                  <span class="tooltip-text">Wenn der Pufferspeicher auch zur Erwärmung von Trinkwasser (z.B. über eine Frischwasserstation) genutzt wird, muss zusätzliches Volumen vorgehalten werden. <b>(~ +12 %)</b></span>
              </div>
            </div>
          </div>
          <div class="card-grid" id="dhwCards">
            <button class="card-btn small-card active" type="button" role="option" aria-selected="true" aria-pressed="true" data-value="no">
              <div class="card-svg">
                <!-- DHW NO ICON -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 64" role="img">
                  <style>
                    .card { fill:var(--body); stroke: var(--line); stroke-width:1.5; }
                    .tank { fill:url(#tankFill-dhw-no); stroke: var(--line); stroke-width:1.8; }
                    .port { fill:var(--body); stroke: var(--line); stroke-width:1.4; }
                    .label { fill:var(--body); stroke: var(--line); stroke-width:1.4; }
                    .badge { fill:var(--body); stroke: var(--c-text-muted); stroke-width:1.8; }
                    .cross { stroke: var(--c-text-muted); stroke-width:2.4; stroke-linecap:round; }
                  </style>
                  <defs>
                    <linearGradient id="tankFill-dhw-no" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="0%"  stop-color="#f7fbff"/>
                      <stop offset="100%" stop-color="#eef5fd"/>
                    </linearGradient>
                  </defs>
                  <rect class="card" x="2" y="6" width="92" height="52" rx="10"/>
                  <g transform="translate(24,10)">
                    <rect class="tank" x="0" y="4" width="36" height="36" rx="8"/>
                    <rect class="port" x="15" y="0.5" width="6" height="5" rx="1"/>
                    <rect class="port" x="15" y="40.5" width="6" height="5" rx="1"/>
                    <rect class="label" x="28" y="10" width="6" height="10" rx="1.5"/>
                    <circle cx="31" cy="13" r="1.2" fill="var(--brand)"/>
                    <rect x="29.5" y="16" width="3" height="1.6" rx="0.8" fill="var(--line)"/>
                  </g>
                  <g transform="translate(64,14)">
                    <circle class="badge" cx="12" cy="12" r="10"/>
                    <path class="cross" d="M8.5 8.5 L15.5 15.5 M15.5 8.5 L8.5 15.5"/>
                  </g>
                </svg>
              </div>
              <p class="card-title">Nein</p>
            </button>
            <button class="card-btn small-card" type="button" role="option" aria-selected="false" aria-pressed="false" data-value="yes">
              <div class="card-svg">
                <!-- DHW YES ICON -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 64" role="img">
                  <style>
                    .card { fill:var(--body); stroke: var(--line); stroke-width:1.5; }
                    .tank { fill:url(#tankFill-dhw); stroke: var(--line); stroke-width:1.8; }
                    .coil { fill:none; stroke: var(--brand); stroke-width:2.2; stroke-linecap:round; }
                    .port { fill:var(--body); stroke: var(--line); stroke-width:1.4; }
                    .badge { fill:var(--body); stroke: var(--ok, #16a34a); stroke-width:1.8; }
                    .check { fill: var(--ok, #16a34a); }
                    .label { fill:var(--body); stroke: var(--line); stroke-width:1.4; }
                  </style>
                  <defs>
                    <linearGradient id="tankFill-dhw" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="0%"  stop-color="#f7fbff"/>
                      <stop offset="100%" stop-color="#eef5fd"/>
                    </linearGradient>
                  </defs>
                  <rect class="card" x="2" y="6" width="92" height="52" rx="10"/>
                  <g transform="translate(24,10)">
                    <rect class="tank" x="0" y="4" width="36" height="36" rx="8"/>
                    <rect class="port" x="15" y="0.5" width="6" height="5" rx="1"/>
                    <rect class="port" x="15" y="40.5" width="6" height="5" rx="1"/>
                    <path class="coil" d="M8 14 h20 a4 4 0 0 1 0 8 h-20 a4 4 0 0 0 0 8 h20" />
                    <rect class="label" x="28" y="10" width="6" height="10" rx="1.5"/>
                    <circle cx="31" cy="13" r="1.2" fill="var(--brand)"/>
                    <rect x="29.5" y="16" width="3" height="1.6" rx="0.8" fill="var(--line)"/>
                  </g>
                  <g transform="translate(64,14)">
                    <circle class="badge" cx="12" cy="12" r="10"/>
                    <path class="check" d="M7.5 12.2l3.2 3.2 6.6-6.6a1.4 1.4 0 0 1 2 2l-7.6 7.6a1.6 1.6 0 0 1-2.3 0l-4.3-4.3a1.4 1.4 0 1 1 2-2z"/>
                  </g>
                </svg>
              </div>
              <p class="card-title">Ja, integriert</p>
            </button>
          </div>
        </div>

        <div class="field">
          <div class="label">
            <div class="label-group">
              <span>EVU‑Sperrzeiten</span>
              <div class="tooltip" tabindex="0">?
                  <span class="tooltip-text">Manche Stromtarife erlauben dem Energieversorger (EVU), die Anlage für einige Stunden am Tag abzuschalten. Der Pufferspeicher muss diese Zeit überbrücken. <b>(+ ~6 % pro Stunde)</b></span>
              </div>
            </div>
          </div>
          <div class="card-grid" id="evuCards">
            <button class="card-btn small-card active" type="button" role="option" aria-selected="true" aria-pressed="true" data-value="no">
              <div class="card-svg">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
              </div>
              <p class="card-title">Nein</p>
            </button>
            <button class="card-btn small-card" type="button" role="option" aria-selected="false" aria-pressed="false" data-value="yes">
              <div class="card-svg">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10" stroke="#fbbf24" opacity="0.8"/>
                  <line x1="10" y1="15" x2="10" y2="9" stroke="#fbbf24" opacity="0.8"/><line x1="14" y1="15" x2="14" y2="9" stroke="#fbbf24" opacity="0.8"/>
                </svg>
              </div>
              <p class="card-title">Ja, vorhanden</p>
            </button>
          </div>
        </div>
      </div>
      <div id="evuHoursWrap" class="field" style="display:none;margin-top:8px">
        <div class="label">Dauer der Sperre pro Tag (h)</div>
        <input id="evuHours" type="number" inputmode="numeric" min="0" max="8" step="1" value="2" />
      </div>

      <!-- Sliders -->
      <div class="row">
        <div class="field">
            <div class="label">
              <div class="label-group">
                <span>Komfort / Sicherheitszuschlag</span>
                <div class="tooltip" tabindex="0">?
                    <span class="tooltip-text">Ein Zuschlag erhöht die gespeicherte Energiemenge. Das führt zu längeren, effizienteren Laufzeiten der Wärmepumpe und bietet mehr Reserven, erhöht aber auch die Bereitschaftsverluste des Speichers. <b>(0 / +10 / +20 %)</b></span>
                </div>
              </div>
              <span id="comfortValueDisplay" class="chip">Mittel (+10%)</span>
            </div>
            <input id="comfortSlider" class="range comfort-slider" type="range" min="0" max="2" step="1" value="1" />
        </div>
        <div class="field">
            <div class="label">
              <div class="label-group">
                <span>Platzverfügbarkeit</span>
                 <div class="tooltip" tabindex="0">?
                    <span class="tooltip-text">Beeinflusst nicht die Berechnung, sondern meldet, wenn die empfohlene Standardgröße Ihre baulichen Grenzen überschreitet.</span>
                </div>
              </div>
              <span id="spaceValueDisplay" class="chip">Mittel (≤ 800 l)</span>
            </div>
            <input id="spaceSlider" class="range space-slider" type="range" min="0" max="2" step="1" value="1" />
        </div>
      </div>
      <div class="field">
        <div class="label">
          <div class="label-group">
            <span>Ziel‑Vorlauftemperatur</span>
            <div class="tooltip" tabindex="0">?
                <span class="tooltip-text">Höhere Vorlauftemperaturen (z.B. für Heizkörper) senken die Effizienz. Ein etwas größerer Puffer kann die Taktung verbessern. <b>+5 % ab 45 °C, +10 % ab 55 °C</b></span>
            </div>
          </div>
          <span id="supplyValueDisplay" class="chip">35 °C</span>
        </div>
        <input id="supplySlider" class="range temp-slider" type="range" min="25" max="70" step="1" value="35" />
      </div>
    </section>

    <!-- OUTPUTS -->
    <section class="panel" aria-labelledby="outputs">
      <h2 id="outputs">Ergebnis</h2>

      <div class="result">
        <div class="stat-grid">
          <div class="stat">
            <h3>Empfohlene Größe</h3>
            <div class="big" id="resLiters">–</div>
          </div>
          <div class="stat">
            <h3>Optimale Spanne</h3>
            <div class="big" id="resRange">–</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="stat">
          <h3>Nächste Standardgröße</h3>
          <div class="big" id="resStd">–</div>
        </div>

        <div class="divider"></div>

        <!-- Gauge Visualization -->
        <div>
          <div class="label" style="justify-content:flex-start">
            <div class="label-group">
                <span>Volumen pro kW (l/kW) – Einordnung</span>
            </div>
          </div>
          <div class="gauge" aria-label="Einordnung l/kW">
            <div class="fill" id="gaugeFill" style="width:0%"></div>
            <div class="tick" data-mark="20"></div>
            <div class="tick" data-mark="30"></div>
            <div class="tick" data-mark="50"></div>
            <div class="tick" data-mark="80"></div>
          </div>
          <div class="legend">
            <span><span class="dot ok"></span> ~20 l/kW</span>
            <span><span class="dot mid"></span> ~30–50 l/kW</span>
            <span><span class="dot bad"></span> ≥80 l/kW</span>
          </div>
        </div>

        <div class="divider"></div>

        <p id="resMsg" class="note">–</p>
        <p id="resWarn" class="help" style="margin-top:6px">–</p>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn-primary" id="shopBtn" href="#" target="_blank" rel="noopener">Passenden Speicher im Shop anzeigen</a>
          <button class="btn-primary" onclick="window.print();return false;">Ergebnis als PDF speichern</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== Cards =====
    const sysCards     = document.querySelectorAll('#systemCards .card-btn');
    const emitterCards = document.querySelectorAll('#emitterCards .card-btn');
    const dhwCards     = document.querySelectorAll('#dhwCards .card-btn');
    const evuCards     = document.querySelectorAll('#evuCards .card-btn');

    // ===== Inputs =====
    const powerRange = document.getElementById('powerRange');
    const powerNum   = document.getElementById('powerNum');
    const evuHoursWrap = document.getElementById('evuHoursWrap');
    const evuHours   = document.getElementById('evuHours');
    const comfortSlider = document.getElementById('comfortSlider');
    const comfortValueDisplay = document.getElementById('comfortValueDisplay');
    const spaceSlider = document.getElementById('spaceSlider');
    const spaceValueDisplay = document.getElementById('spaceValueDisplay');
    const supplySlider = document.getElementById('supplySlider');
    const supplyValueDisplay = document.getElementById('supplyValueDisplay');

    // ===== Outputs =====
    const resLiters = document.getElementById('resLiters');
    const resRange  = document.getElementById('resRange');
    const resStd    = document.getElementById('resStd');
    const resMsg    = document.getElementById('resMsg');
    const resWarn   = document.getElementById('resWarn');
    const gaugeFill = document.getElementById('gaugeFill');

    // ===== Misc =====
    const shopBtn   = document.getElementById('shopBtn');
    const themeToggle = document.getElementById('themeToggle');

    // --- State ---
    const state = {
      system: 'monovalent',
      power: 10,
      emitters: 'flaeche',
      dhw: 'no',
      evu: 'no',
      evuHours: 2,
      comfort: 10,
      space: 'mid',
      supply: 35
    };

    // --- Helpers ---
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function fmt(n){ return Intl.NumberFormat('de-DE').format(Math.round(n)); }
    function fmt10(n){ return Intl.NumberFormat('de-DE').format(Math.round(n/10)*10); }

    const STD = [100,200,300,400,500,600,800,1000];
    const PRODUKTE = {
      100: 'https://www.westech.shop/heizkraft-silo-pss-100-gr-pufferspeicher-100l',
      200: 'https://www.westech.shop/heizkraft-silo-pss-200-gr-pufferspeicher-200l',
      300: 'https://www.westech.shop/heizkraft-silo-pss-300-gr-pufferspeicher-300l',
      400: 'https://www.westech.shop/Pufferspeicher',
      500: 'https://www.westech.shop/heizkraft-silo-pss-500-gr-pufferspeicher-500l',
      600: 'https://www.westech.shop/Pufferspeicher',
      800: 'https://www.westech.shop/heizkraft-silo-ps-800-gr-pufferspeicher-800l-soft-polyurethane',
      1000:'https://www.westech.shop/heizkraft-silo-ps1-1000-gr-pufferspeicher-1000l-pexl-poly'
    };
    const BASE = { mono: 25, bi: 45 };

    function emitterFactor(type){
      if(type==='flaeche') return 0.90;
      if(type==='radiator') return 1.10;
      return 1.00;
    }
    function evuFactor(hours){ return 1 + (0.06 * hours); }
    function comfortFactor(pct){ return 1 + (pct/100); }
    function dhwFactor(val){ return val==='yes' ? 1.12 : 1.00; }
    function supplyHintFactor(temp){
      if(!temp) return 1.00;
      if(temp >= 55) return 1.10;
      if(temp >= 45) return 1.05;
      return 1.00;
    }
    function spaceLimit(space){
      if(space==='small') return 500;
      if(space==='mid') return 800;
      return 1200;
    }
    function nextStandard(vol){
      for(const v of STD){ if(v >= vol) return v; }
      return STD[STD.length-1];
    }
    function produktLink(std){ return PRODUKTE[std] || 'https://www.westech.shop/Pufferspeicher'; }

    // --- Calculation ---
    function calculate(){
      const P = clamp(Number(state.power)||0, 1, 100);
      const base = (state.system==='monovalent') ? BASE.mono : BASE.bi;
      let factor = 1.0;

      factor *= emitterFactor(state.emitters);
      if(state.evu==='yes'){ factor *= evuFactor(Number(state.evuHours)||0); }
      factor *= comfortFactor(Number(state.comfort)||0);
      factor *= dhwFactor(state.dhw);
      factor *= supplyHintFactor(state.supply ? Number(state.supply) : null);

      const l_per_kw = base * factor;
      const V = l_per_kw * P;
      const Vmin = V * 0.92;
      const Vmax = V * 1.08;
      const gaugePct = Math.max(0, Math.min(100, (l_per_kw/100)*100));
      const std = nextStandard(V);

      let msg = `Berechnet auf Basis von ${P.toFixed(1)} kW, Systemart „${state.system}“, Heizflächen „${labelEmitters(state.emitters)}”`;
      if(state.evu==='yes') msg += ` und ${state.evuHours} h EVU‑Sperre`;
      if(state.dhw==='yes') msg += ` inkl. Warmwasserbereitung`;
      msg += `.`;

      let warn = '';
      const spaceMax = spaceLimit(state.space);
      if( (V/P) >= 80 ) warn += '⚠️ Sehr hohes l/kW‑Verhältnis (≥80). Prüfe Bereitschaftsverluste, Dämmung und Regelstrategie. ';
      if( std > spaceMax ) warn += `📏 Platzgrenze überschritten (gewählt: ${state.space}). Prüfe Aufstellbedingungen oder kleinere Range. `;

      resLiters.textContent = `${fmt(V)} Liter (${Math.round(l_per_kw)} l/kW)`;
      resRange.textContent  = `${fmt10(Vmin)}–${fmt10(Vmax)} Liter`;
      resStd.textContent    = `${fmt(std)} Liter`;
      gaugeFill.style.width = `${gaugePct}%`;
      resMsg.textContent    = msg;
      resWarn.textContent   = warn || ' ';

      shopBtn.href = produktLink(std);

      // update tick positions based on marks 20/30/50/80 (scale 0..100)
      document.querySelectorAll('.gauge .tick').forEach(t => {
        const mark = Number(t.getAttribute('data-mark')) || 0;
        const pos = Math.max(0, Math.min(100, (mark/100)*100));
        t.style.left = pos + '%';
      });
    }

    function labelEmitters(val){
      if(val==='flaeche') return 'Flächenheizung';
      if(val==='radiator') return 'Heizkörper';
      return 'Mischsystem';
    }

    // --- Event Listeners ---
    function setupCardSelection(cards, stateKey) {
      cards.forEach(btn => {
        btn.addEventListener('click', () => {
          cards.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected','false'); b.setAttribute('aria-pressed','false'); });
          btn.classList.add('active');
          btn.setAttribute('aria-selected','true');
          btn.setAttribute('aria-pressed','true');
          state[stateKey] = btn.dataset.value;
          if (stateKey === 'evu') evuHoursWrap.style.display = (state.evu === 'yes') ? 'block' : 'none';
          calculate();
        });
      });
    }

    function setupEventListeners() {
      setupCardSelection(sysCards, 'system');
      setupCardSelection(emitterCards, 'emitters');
      setupCardSelection(dhwCards, 'dhw');
      setupCardSelection(evuCards, 'evu');

      powerRange.addEventListener('input', ()=>{ powerNum.value = Number(powerRange.value); state.power = Number(powerRange.value); calculate(); });
      powerNum.addEventListener('input', ()=>{ const v = clamp(Number(powerNum.value)||0, 1, 100); powerRange.value = v; state.power = v; calculate(); });
      evuHours.addEventListener('input', ()=>{ state.evuHours = clamp(Number(evuHours.value)||0, 0, 12); calculate(); });

      comfortSlider.addEventListener('input', () => { const vals=[0,10,20]; const labels=['Minimal (0%)','Mittel (+10%)','Hoch (+20%)']; state.comfort = vals[comfortSlider.value]; comfortValueDisplay.textContent = labels[comfortSlider.value]; calculate(); });
      spaceSlider.addEventListener('input', () => { const vals=['small','mid','large']; const labels=['Klein (≤ 500 l)','Mittel (≤ 800 l)','Groß (≥ 1000 l)']; state.space = vals[spaceSlider.value]; spaceValueDisplay.textContent = labels[spaceSlider.value]; calculate(); });
      supplySlider.addEventListener('input', () => { const v = Number(supplySlider.value); state.supply = v; supplyValueDisplay.textContent = `${v} °C`; calculate(); });
    }

    // --- Theme Switcher ---
    function applyTheme(theme) { if (theme === 'light') document.documentElement.classList.add('light-mode'); else document.documentElement.classList.remove('light-mode'); localStorage.setItem('theme', theme); }
    themeToggle.addEventListener('click', () => { const newTheme = document.documentElement.classList.contains('light-mode') ? 'dark' : 'light'; applyTheme(newTheme); });

    // --- Init ---
    function init() {
      const savedTheme = localStorage.getItem('theme');
      const currentTheme = savedTheme || 'light';
      applyTheme(currentTheme);
      setupEventListeners();
      calculate();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
